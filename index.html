<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no" />
  <title>Arbitrage Stake Calculator</title>
  <!-- Telegram WebApp Script -->
  <script src="https://telegram.org/js/telegram-web-app.js"></script>
  <style>
    /* Telegram Theme Variables with Fallback */
    :root {
      --bg: var(--tg-theme-bg-color, #0f172a);
      --card: var(--tg-theme-secondary-bg-color, #111827);
      --muted: var(--tg-theme-hint-color, #94a3b8);
      --fg: var(--tg-theme-text-color, #e5e7eb);
      --acc: var(--tg-theme-button-color, #22d3ee);
      --btn-text: var(--tg-theme-button-text-color, #001017);
      --green: #22c55e;
    }
    *{box-sizing:border-box}
    body{
      margin:0; font-family:system-ui,-apple-system,Segoe UI,Roboto,Inter,Arial;
      background:var(--bg); color:var(--fg);
      min-height:100vh; display:flex; align-items:center; justify-content:center; padding:20px;
    }
    .wrap{width:100%; max-width:600px} /* Kicsit szÅ±kebb max-width mobilosabb Ã©rzethez */
    .title{font-weight:800; letter-spacing:.2px; margin:0 0 10px; font-size:24px; text-align: center;}
    .subtitle{color:var(--muted); margin:0 0 20px; font-size:14px; text-align: center; line-height: 1.4;}
    
    .card{
      background:var(--card); 
      border:1px solid rgba(148,163,184,.1);
      border-radius:16px; padding:20px; 
      box-shadow:0 4px 20px rgba(0,0,0,.2);
    }
    .grid{display:grid; gap:16px; grid-template-columns:repeat(2,1fr)}
    .col-1{grid-column:span 1} 
    .col-2{grid-column:span 2} 

    label{display:block; font-size:13px; color:var(--muted); margin-bottom:6px}
    input{
      width:100%; padding:14px; border-radius:12px; 
      border:1px solid rgba(148,163,184,.2);
      background:var(--bg); color:var(--fg); outline:none; font-size:16px;
      transition:border-color .15s;
    }
    input:focus{border-color:var(--acc); }
    
    .btnbar{display:flex; gap:10px; margin-top:10px}
    button{
      appearance:none; border:none; background:var(--acc);
      color:var(--btn-text); font-weight:700; padding:14px; border-radius:12px; cursor:pointer;
      flex:1; font-size:15px;
      transition:opacity .2s;
    }
    button:active{opacity:0.8}
    .btn-ghost{
      background:transparent; color:var(--fg); border:1px solid rgba(148,163,184,.3); flex:0 auto;
    }
    
    .out{
      background:var(--bg); border-radius:14px; padding:16px;
      display:flex; flex-direction: column; gap:12px; margin-top: 10px;
    }
    .kv{display:flex; justify-content: space-between; align-items:center; padding: 4px 0; border-bottom: 1px dashed rgba(148,163,184,.15);}
    .kv:last-child{border-bottom:none}
    .k{color:var(--muted); font-size:14px;}
    .v-group {display:flex; align-items: center; gap: 8px;}
    .v{font-variant-numeric:tabular-nums; font-size: 16px; font-weight: 600;}
    .v.money{color:var(--green);}

    /* Copy Button Styles */
    .copy-btn {
        background: rgba(148,163,184,0.15); color: var(--muted);
        border: none; border-radius: 6px; padding: 4px 8px;
        cursor: pointer; font-size: 12px; display: flex; align-items: center; justify-content: center;
        width: 32px; height: 32px; transition: all 0.2s;
        flex: none; /* Ne nyÃºljon meg */
    }
    .copy-btn:hover { background: rgba(148,163,184,0.3); color: var(--fg); }
    .copy-btn.copied { background: var(--green); color: #fff; }

    .err{color:#fca5a5; background:rgba(127,29,29,0.3); border:1px solid rgba(127,29,29,0.5); padding:12px; border-radius:12px; display:none; font-size: 14px; margin-top: 10px;}
    .hint{color:var(--muted); font-size:12px; margin-top: 4px;}
    .foot{color:var(--muted); margin-top:20px; font-size:11px; text-align: center; opacity: 0.6;}
    .mono{font-family:monospace}
    
    /* Ha Telegramban vagyunk, rejtsÃ¼k el a webes Calculate gombot, mert ott a MainButton */
    body.is-telegram #calcBtn { display: none; }
  </style>
</head>
<body>
  <div class="wrap">
    <h1 class="title">Arbitrage Calc</h1>
    <p class="subtitle">Target profit with smart rounding</p>

    <div class="card">
      <div class="grid">
        <div class="col-1">
          <label>Odds A</label>
          <input id="oddsA" type="number" inputmode="decimal" step="0.01" min="1.01" placeholder="2.10" />
        </div>
        <div class="col-1">
          <label>Odds B</label>
          <input id="oddsB" type="number" inputmode="decimal" step="0.01" min="1.01" placeholder="1.90" />
        </div>
        <div class="col-1">
          <label>Profit (Â£)</label>
          <input id="profit" type="number" inputmode="decimal" step="0.01" min="0.01" placeholder="10" />
        </div>
        <div class="col-1">
          <label>Rounding (Â£)</label>
          <input id="step" type="number" inputmode="decimal" step="0.01" min="0.01" value="5" />
        </div>

        <div class="col-2 btnbar">
          <button id="calcBtn">CALCULATE</button>
          <button id="resetBtn" class="btn-ghost">Reset</button>
        </div>

        <div id="err" class="col-2 err"></div>

        <div class="col-2">
          <div class="out">
            <!-- Stake A -->
            <div class="kv">
                <div class="k">Stake A</div>
                <div class="v-group">
                    <div id="outA" class="v money mono">â€”</div>
                    <button class="copy-btn" onclick="copyToClip('outA', this)" title="Copy">ðŸ“‹</button>
                </div>
            </div>

            <!-- Stake B -->
            <div class="kv">
                <div class="k">Stake B</div>
                <div class="v-group">
                    <div id="outB" class="v money mono">â€”</div>
                    <button class="copy-btn" onclick="copyToClip('outB', this)" title="Copy">ðŸ“‹</button>
                </div>
            </div>

            <!-- Total Stake -->
            <div class="kv">
                <div class="k">Total Stake</div>
                <div class="v-group">
                    <div id="outTotal" class="v mono">â€”</div>
                </div>
            </div>

            <!-- Profit -->
            <div class="kv">
                <div class="k">Guaranteed Profit</div>
                <div id="outProfit" class="v money mono">â€”</div>
            </div>

            <!-- ROI -->
            <div class="kv">
                <div class="k">ROI</div>
                <div class="v-group">
                    <div id="outRoi" class="v mono">â€”</div>
                    <span style="font-size:12px; color:var(--muted)">%</span>
                </div>
            </div>
          </div>
        </div>

        <div class="col-2 foot">
            <div id="diag" class="mono" style="display:none;"></div>
        </div>
      </div>
    </div>
  </div>

  <script>
    const $ = (id) => document.getElementById(id);
    const fmt2 = (x) => Number.isFinite(x) ? x.toFixed(2) : "â€”";
    
    // --- Telegram WebApp Setup ---
    let tg = window.Telegram.WebApp;
    
    function initTelegram() {
        if (tg.initDataUnsafe && Object.keys(tg.initDataUnsafe).length > 0) {
            tg.expand(); // Teljes kÃ©pernyÅ‘
            document.body.classList.add('is-telegram');
            
            // Main Button beÃ¡llÃ­tÃ¡sa
            tg.MainButton.setText("CALCULATE");
            tg.MainButton.show();
            tg.MainButton.onClick(calculate);
            
            // SzÃ­nvilÃ¡g frissÃ­tÃ©se, ha vÃ¡ltozik a tÃ©ma
            tg.onEvent('themeChanged', function() {
                document.documentElement.style.setProperty('--bg', tg.themeParams.bg_color);
                // TovÃ¡bbi szÃ­neket automatikusan kezel a var() fallback
            });
        }
    }

    // --- LocalStorage Handling ---
    function loadSettings() {
        const savedProfit = localStorage.getItem('arb_profit');
        const savedStep = localStorage.getItem('arb_step');
        if (savedProfit) $("profit").value = savedProfit;
        if (savedStep) $("step").value = savedStep;
    }

    function saveSettings() {
        localStorage.setItem('arb_profit', $("profit").value);
        localStorage.setItem('arb_step', $("step").value);
    }

    // --- Clipboard Function ---
    window.copyToClip = function(elementId, btn) {
        const text = $(elementId).textContent;
        if (text === "â€”" || !text) return;
        
        // Mobilon a clipboard API nÃ©ha trÃ¼kkÃ¶s, fallback megoldÃ¡s
        if (navigator.clipboard && navigator.clipboard.writeText) {
            navigator.clipboard.writeText(text).then(() => showCopied(btn));
        } else {
            // Fallback rÃ©gebbi eszkÃ¶zÃ¶kre
            const textArea = document.createElement("textarea");
            textArea.value = text;
            document.body.appendChild(textArea);
            textArea.select();
            try { document.execCommand('copy'); showCopied(btn); } catch (err) {}
            document.body.removeChild(textArea);
        }
    };

    function showCopied(btn) {
        const original = btn.innerHTML;
        btn.innerHTML = "âœ“";
        btn.classList.add("copied");
        // Haptic feedback ha Telegramban vagyunk
        if(tg.HapticFeedback) tg.HapticFeedback.notificationOccurred('success');
        
        setTimeout(() => {
            btn.innerHTML = original;
            btn.classList.remove("copied");
        }, 1500);
    }

    // --- Core Logic ---
    function roundToStep(value, step){
      if (step <= 0) return value;
      return Math.round(value / step) * step;
    }

    function calculate(){
      const err = $("err");
      err.style.display = "none";
      err.textContent = "";

      const oddsA = parseFloat($("oddsA").value);
      const oddsB = parseFloat($("oddsB").value);
      const targetProfit = parseFloat($("profit").value);
      const step = parseFloat($("step").value);

      // Save inputs for next time
      saveSettings();

      if (!(oddsA > 1.01) || !(oddsB > 1.01) || !(targetProfit > 0) || !(step > 0)){
        err.textContent = "Check inputs!";
        err.style.display = "block";
        if(tg.HapticFeedback) tg.HapticFeedback.notificationOccurred('error');
        return;
      }

      const invSum = 1/oddsA + 1/oddsB;
      if (invSum >= 1){
        err.textContent = `No arb: ${(invSum*100).toFixed(1)}%`;
        err.style.display = "block";
        setOutputs(null);
        if(tg.HapticFeedback) tg.HapticFeedback.notificationOccurred('warning');
        return;
      }

      const den = oddsA*oddsB - oddsA - oddsB;
      let stakeA = (targetProfit * oddsB) / den;
      let stakeB = (targetProfit * oddsA) / den;

      stakeA = roundToStep(stakeA, step);
      stakeB = roundToStep(stakeB, step);

      let total = stakeA + stakeB;
      let profitIfA = stakeA * oddsA - total;
      let profitIfB = stakeB * oddsB - total;
      let guaranteed = Math.min(profitIfA, profitIfB);

      // Trimming logic
      let guard = 0;
      while (guaranteed < -0.01 && (stakeA > 0 || stakeB > 0) && guard < 1000){
        if (stakeA >= stakeB) stakeA = Math.max(0, stakeA - step);
        else stakeB = Math.max(0, stakeB - step);
        
        total = stakeA + stakeB;
        profitIfA = stakeA * oddsA - total;
        profitIfB = stakeB * oddsB - total;
        guaranteed = Math.min(profitIfA, profitIfB);
        guard++;
      }

      const roi = total > 0 ? (guaranteed / total * 100) : 0;
      setOutputs({ stakeA, stakeB, total, guaranteed, roi });
      
      if(tg.HapticFeedback) tg.HapticFeedback.impactOccurred('light');
    }

    function setOutputs(res){
      const set = (id, val) => $(id).textContent = val;
      if (!res){
        set("outA","â€”"); set("outB","â€”"); set("outTotal","â€”"); set("outProfit","â€”"); set("outRoi","â€”");
        return;
      }
      set("outA", fmt2(res.stakeA));
      set("outB", fmt2(res.stakeB));
      set("outTotal", fmt2(res.total));
      set("outProfit", "Â£" + fmt2(res.guaranteed));
      set("outRoi", res.roi.toFixed(2));
      
      // Visual warning if profit is very low/negative
      $("outProfit").style.color = res.guaranteed < 0 ? "#f87171" : "var(--green)";
    }

    // --- URL Params & Init ---
    (function init(){
        initTelegram();
        loadSettings(); // Load saved Step/Profit
        
        try {
            const params = new URLSearchParams(window.location.search);
            const pA = params.get("oddsA");
            const pB = params.get("oddsB");
            if (pA) $("oddsA").value = pA;
            if (pB) $("oddsB").value = pB;
        } catch (e) {}
    })();

    $("calcBtn").addEventListener("click", calculate);
    $("resetBtn").addEventListener("click", () => {
      $("oddsA").value = ""; $("oddsB").value = "";
      setOutputs(null);
      $("err").style.display = "none";
    });

  </script>
</body>
</html>
